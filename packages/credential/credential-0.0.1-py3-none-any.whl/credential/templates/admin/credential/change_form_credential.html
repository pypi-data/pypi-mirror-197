{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}
{% block content %}
{{ block.super }}
<div style="display:none" id="spinner">
    <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>
<div id="render-form" class="col-9"><div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script>
      $(document).ready( async function() {
        let objectId = "{{object_id}}";
        if(objectId != "None" && objectId){
            $("#render-form").empty();
            $("#spinner").show();
            fetch(window.location.protocol + "//" + window.location.host + "/credentials/get_new_form_rendered/?object_id=" + objectId)
            .then((response) => response.json())
            .then((data) => {
                let form = data["form"].replace(/(\r\n|\n|\r)/gm, "");
                $("#render-form").append(form);
                $("#spinner").hide();
            });
        }
        $('#credential_form').submit(function(e) {
            e.preventDefault();
            if (!$('#credential').length){
                $('<input>').attr('type','hidden').attr('id', 'credential').attr('name', 'credential').appendTo('#credential_form');
            }
            let credential = $('#rendered_form').serializeArray().filter(data => data.name == 'credential')[0];
            if(credential){
                $('#credential').val(JSON.stringify(credential));
                $('#credential_form')[0].submit();
            } else{
                alert("Please select a credential type.");
            }
        });
        $('#id_credential_type').change(async function(){
            $("#render-form").empty();
            $("#spinner").show();
            var id = $('#id_credential_type').val();
            if (id != 0) {
                fetch(window.location.protocol + "//" + window.location.host + "/credentials/get_new_form_rendered/?credential_type_id=" + id)
                .then((response) => response.json())
                .then((data) => {
                    $("#render-form").append(data["form"]);
                    $("#spinner").hide();
                });
            }
        });
     });
</script>
{% endblock %}
